import { type NextRequest, NextResponse } from "next/server"

export async function POST(request: NextRequest) {
  try {
    const { resumeText, jobDescription, additionalExperience } = await request.json()

    if (!jobDescription) {
      return NextResponse.json({ error: "å²—ä½æè¿°ä¸èƒ½ä¸ºç©º" }, { status: 400 })
    }

    const apiKey = process.env.ECNU_API_KEY
    if (!apiKey) {
      return NextResponse.json({ error: "APIå¯†é’¥æœªé…ç½®" }, { status: 500 })
    }

    // åˆ›å»ºæµå¼å“åº”
    const encoder = new TextEncoder()
    const stream = new ReadableStream({
      async start(controller) {
        try {
          // å‘é€å¼€å§‹ä¿¡å·
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "progress",
            step: 1,
            total: 4,
            message: "å¼€å§‹åˆ†æç®€å†ä¿¡æ¯..."
          })}\n\n`))

          // èŠ‚ç‚¹1ï¼šç®€å†åŸå§‹ä¿¡æ¯æå–
          const node1Result = await extractResumeInfo(resumeText, additionalExperience, apiKey)
          
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "progress",
            step: 2,
            total: 4,
            message: "æ­£åœ¨åˆ†æå²—ä½è¦æ±‚..."
          })}\n\n`))

          // èŠ‚ç‚¹2ï¼šJDåˆ†æ
          const node2Result = await analyzeJobDescription(jobDescription, apiKey)
          
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "progress",
            step: 3,
            total: 4,
            message: "æ­£åœ¨è¿›è¡ŒåŒ¹é…åˆ†æ..."
          })}\n\n`))

          // èŠ‚ç‚¹3ï¼šåŒ¹é…åˆ†æ
          const node3Result = await performMatchingAnalysis(node1Result, node2Result, jobDescription, apiKey)
          
          // å‘é€åŒ¹é…åˆ†æç»“æœ
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "partial_result",
            data: {
              matchScore: node3Result.matchScore,
              matchLevel: node3Result.matchLevel,
              coreSkillsMatch: node3Result.coreSkillsMatch,
              summary: node3Result.summary,
              detailedScore: node3Result.detailedScore
            }
          })}\n\n`))

          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "progress",
            step: 4,
            total: 4,
            message: "æ­£åœ¨ç”Ÿæˆä¼˜åŒ–åçš„ç®€å†..."
          })}\n\n`))

          // èŠ‚ç‚¹4ï¼šç®€å†ä¼˜åŒ–
          const node4Result = await generateOptimizedResume(
            node1Result, 
            node2Result, 
            node3Result, 
            jobDescription, 
            apiKey
          )

          // å‘é€æœ€ç»ˆç»“æœ
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "final_result",
            data: {
              matchScore: node3Result.matchScore,
              matchLevel: node3Result.matchLevel,
              coreSkillsMatch: node3Result.coreSkillsMatch,
              summary: node3Result.summary,
              optimizedResume: node4Result,
              detailedScore: node3Result.detailedScore,
              rawResumeExtraction: node1Result,
              jobAnalysis: node2Result
            }
          })}\n\n`))

          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "complete"
          })}\n\n`))

          controller.close()
        } catch (error) {
          console.error("æµå¼åˆ†æé”™è¯¯:", error)
          controller.enqueue(encoder.encode(`data: ${JSON.stringify({
            type: "error",
            error: "åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯",
            details: error instanceof Error ? error.message : "æœªçŸ¥é”™è¯¯"
          })}\n\n`))
          controller.close()
        }
      }
    })

    return new Response(stream, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
      },
    })
  } catch (error) {
    console.error("ç®€å†åˆ†æé”™è¯¯:", error)
    return NextResponse.json(
      {
        error: "åˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯",
        details: error instanceof Error ? error.message : "æœªçŸ¥é”™è¯¯",
      },
      { status: 500 },
    )
  }
}

// èŠ‚ç‚¹1ï¼šç®€å†åŸå§‹ä¿¡æ¯æå–
async function extractResumeInfo(resumeText: string, additionalExperience: string, apiKey: string) {
  const extractionPrompt = `ä½ ç°åœ¨çš„ä»»åŠ¡æ˜¯ï¼šå¯¹ä»¥ä¸‹ç®€å†å†…å®¹ï¼ˆ${resumeText || "æœªæä¾›ç®€å†"}ï¼‰è¿›è¡ŒåŸå§‹ä¿¡æ¯æå–ï¼Œä¸åšä»»ä½•åŠ å·¥ã€ç¾åŒ–æˆ–æ€»ç»“ï¼Œä»…æŒ‰ç…§åŸæ–‡å†…å®¹è¿›è¡Œå®Œæ•´å‘ˆç°ï¼Œå¹¶æŒ‰ä»¥ä¸‹ç»“æ„åˆ†ç±»æ•´ç†ã€‚è¯·é€é¡¹æå–ã€é€å¥è¯»å–ï¼Œç¡®ä¿æ— é—æ¼ã€‚

${additionalExperience ? `è¡¥å……ç»å†ï¼š\n${additionalExperience}` : ""}

â¸»

ç»“æ„è¦æ±‚å¦‚ä¸‹ï¼š

1. ä¸ªäººä¿¡æ¯

è¯·åˆ—å‡º CV ä¸­å‡ºç°çš„æ‰€æœ‰ä¸ªäººåŸºæœ¬ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
â€¢	å§“åï¼ˆå¦‚å‡ºç°ï¼‰
â€¢	æ€§åˆ«ï¼ˆå¦‚å‡ºç°ï¼‰
â€¢	å‡ºç”Ÿå¹´æœˆæˆ–å¹´é¾„ï¼ˆå¦‚å‡ºç°ï¼‰
â€¢	æ‰‹æœºå·ç 
â€¢	é‚®ç®±
â€¢	æ•™è‚²èƒŒæ™¯ï¼ˆé™¢æ ¡åç§°ã€å­¦å†ã€ä¸“ä¸šã€èµ·æ­¢æ—¶é—´ï¼‰
â€¢	æ‰€åœ¨åŸå¸‚æˆ–æœŸæœ›å·¥ä½œåœ°ï¼ˆå¦‚æœ‰ï¼‰
â€¢	æ„å‘å²—ä½

å¦‚æœªå‡ºç°æŸç±»ä¿¡æ¯ï¼Œè¯·å†™"æœªæåŠ"ã€‚

â¸»

2. æ‰€æœ‰ç»å†ï¼ˆå«å®ä¹  / é¡¹ç›® / å…¼èŒ / å­¦æœ¯ç­‰ï¼‰

è¯·å¯¹ CV ä¸­çš„æ¯ä¸€æ®µç»å†é€ä¸€è¿›è¡Œç»“æ„åŒ–æå–ï¼ŒåŒ…æ‹¬ï¼š
â€¢ ç±»åˆ«ï¼šå·¥ä½œç»å†ï¼ˆåŒ…å«å®ä¹ ï¼‰/æ ¡å›­ç»å†/é¡¹ç›®ç­‰
â€¢	æ—¶é—´ï¼šå…·ä½“èµ·æ­¢æ—¶é—´ï¼ˆå¦‚å‡ºç°ï¼‰
â€¢	æ‰€åœ¨å•ä½/é¡¹ç›®ï¼šå¦‚"è…¾è®¯"æˆ–"æ ¡å›­è°ƒç ”é¡¹ç›®"ç­‰
â€¢	è§’è‰²ï¼šå²—ä½æˆ–èŒè´£åç§°ï¼ˆå¦‚"äº§å“å®ä¹ ç”Ÿ"ï¼‰
â€¢	è´Ÿè´£å†…å®¹å’Œå¯¹åº”ç»“æœï¼šCV ä¸­åŸå§‹æè¿°çš„èŒè´£å†…å®¹ä»¥åŠè¯¥å†…å®¹å¯¹åº”çš„ç»“æœã€å½±å“æˆ–å…·ä½“æ•°æ®ï¼ˆé€æ¡åˆ—å‡ºï¼‰

æ¯æ®µç»å†è¯·ç‹¬ç«‹ç¼–å·ï¼Œç¡®ä¿ä¿¡æ¯ä¸æ··æ·†ã€‚å¦‚ä¿¡æ¯æ¨¡ç³Šæˆ–æœªå®Œæ•´å†™å‡ºï¼Œè¯·æ ‡æ³¨"ä¿¡æ¯ä¸å®Œæ•´"ã€‚

â¸»

3. æŠ€èƒ½æ¸…å•

è¯·æå– CV ä¸­æ˜ç¡®æåˆ°çš„æ‰€æœ‰æŠ€èƒ½ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
â€¢	ç¼–ç¨‹è¯­è¨€ / å·¥å…·
â€¢	è½¯ä»¶ä½¿ç”¨èƒ½åŠ›
â€¢	åˆ†æ / è®¾è®¡ / äº§å“ / æ²Ÿé€š ç­‰è½¯ç¡¬æŠ€èƒ½
â€¢	è¯­è¨€èƒ½åŠ›
â€¢	è¯ä¹¦ç±»ä¿¡æ¯ï¼ˆå¦‚å››å…­çº§ã€TOEFLã€PMP ç­‰ï¼‰
â€¢ è¯¾ç¨‹ç»å† / ä¸“ä¸šè¯¾ç¨‹ç­‰

æ‰€æœ‰æŠ€èƒ½è¯·æŒ‰ CV ä¸­åŸæ–‡é€æ¡åˆ—å‡ºï¼Œä¿ç•™åŸå§‹æè¿°ã€‚

â¸»

4. å…¶ä»–ä¿¡æ¯

è¯·æå– CV ä¸­æœªè¢«ä»¥ä¸Šä¸‰ç±»è¦†ç›–çš„æ‰€æœ‰å…¶ä»–ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸é™äºï¼š
â€¢	å¥–é¡¹ / è£èª‰
â€¢	å…´è¶£çˆ±å¥½
â€¢	è‡ªæˆ‘è¯„ä»·
â€¢	ä¸ªäººé¡¹ç›®é“¾æ¥ï¼ˆå¦‚ GitHubã€ä½œå“é›†ç½‘å€ç­‰ï¼‰

â¸»

æå–è¦æ±‚ï¼š
â€¢	æŒ‰åŸæ–‡æå–ä¿¡æ¯ï¼Œä»…åœ¨ç»„ç»‡ç»“æ„ä¸Šè¿›è¡Œåˆ†ç±»ï¼Œä¸æ”¹å˜åŸå§‹è¡¨è¿°
â€¢	ä¿ç•™æ¯ä¸€ä¸ªç»†èŠ‚å’Œæ•°å­—ï¼ˆå¦‚è½¬åŒ–ç‡ã€ç”¨æˆ·æ•°ã€ææ•ˆæ¯”ä¾‹ç­‰ï¼‰
â€¢	å¦‚æœ‰æ˜æ˜¾é‡å¤å†…å®¹ï¼ˆæœ‰ä¸åŒçš„æ¥æºï¼‰ï¼Œè¯·æ•´åˆä¸ºä¸€ä»½
â€¢	å¦‚ä¿¡æ¯æ¨¡ç³Šæˆ–ä¸å®Œæ•´ï¼Œè¯·ç›´æ¥æ ‡æ³¨"ä¿¡æ¯ä¸å®Œæ•´"
â€¢	å¦‚ CV ä¸­å‡ºç°ä¸­è‹±æ··æ’å†…å®¹ï¼Œè¯·ä¿ç•™åŸæ–‡åŸæ ¼å¼

â¸»

è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°ç»“æ„å®Œæ•´æå–ç®€å†ä¿¡æ¯ï¼Œé€æ¡ã€é€å¥åˆ†æï¼Œé¿å…è·³è¿‡ä»»ä½•æœ‰ä»·å€¼å†…å®¹ã€‚`

  const response = await fetch("https://chat.ecnu.edu.cn/open/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      messages: [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç®€å†ä¿¡æ¯æå–ä¸“å®¶ï¼Œæ“…é•¿æŒ‰ç…§åŸæ–‡é€é¡¹æå–ç®€å†å†…å®¹ï¼Œä¸åšä»»ä½•åŠ å·¥æˆ–ç¾åŒ–ã€‚",
        },
        {
          role: "user",
          content: extractionPrompt,
        },
      ],
      model: "ecnu-plus",
      temperature: 0.3,
      stream: false,
    }),
  })

  if (!response.ok) {
    throw new Error(`èŠ‚ç‚¹1 APIè¯·æ±‚å¤±è´¥: ${response.status}`)
  }

  const data = await response.json()
  return data.choices[0]?.message?.content || "ç®€å†ä¿¡æ¯æå–å¤±è´¥"
}

// èŠ‚ç‚¹2ï¼šJDåˆ†æ
async function analyzeJobDescription(jobDescription: string, apiKey: string) {
  const analysisPrompt = `æ‚¨ç°åœ¨æ˜¯ä¸€ä½èµ„æ·±äººæ‰è¯„ä¼°ä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹èŒä½JDï¼ˆ${jobDescription}ï¼‰ï¼Œå¹¶è¾“å‡ºä»¥ä¸‹å…­ç»´åº¦å†…å®¹ï¼š

1. ä¸šåŠ¡ä¸å²—ä½æ¦‚å†µï¼šæ‰€å±è¡Œä¸š/å²—ä½èŒçº§/è§’è‰²åœ¨å›¢é˜Ÿä¸­çš„å®šä½åŠä»·å€¼
2. åŸºæœ¬å¤§ç›˜ï¼šæ¢³ç†èŒä½çš„åŸºç¡€è¦æ±‚ï¼ŒåŒ…æ‹¬å­¦å†èƒŒæ™¯ã€å·¥ä½œç»éªŒå¹´é™ã€è¯­è¨€èƒ½åŠ›ã€é€šç”¨è½¯ä»¶æŠ€èƒ½ã€ç»¼åˆèƒ½åŠ›ç­‰é€šç”¨è¦æ±‚ã€‚
3. æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›ï¼ˆå¿…é¡»ï¼‰ï¼šåˆ†æJDä¸­çš„å…³é”®ä¸“ä¸šæŠ€èƒ½ï¼Œæ ¹æ®é‡è¦æ€§è¯„ä¼°å„é¡¹èƒ½åŠ›çš„ç›¸å¯¹æƒé‡(ä»¥ç™¾åˆ†æ¯”è¡¨ç¤º)ã€‚åˆ—å‡º3-5é¡¹æ ¸å¿ƒèƒ½åŠ›ï¼Œæœ€å¤šäº”é¡¹ï¼Œç¡®ä¿æƒé‡æ€»å’Œä¸º100%ã€‚
4. æ¬¡èƒ½åŠ›ï¼ˆåŠ åˆ†é¡¹ï¼‰ï¼šè¯†åˆ«JDä¸­æåˆ°ä½†æœªä½œä¸ºå¿…è¦æ¡ä»¶çš„æŠ€èƒ½ï¼Œä»¥åŠè¡Œä¸šå†…ç›¸å…³çš„åŠ åˆ†èƒ½åŠ›ã€‚è¿™äº›æŠ€èƒ½ä¼šä½¿å€™é€‰äººåœ¨åŒç­‰æ¡ä»¶ä¸‹è„±é¢–è€Œå‡ºã€‚
5. å·¥ä½œä¿¡æ¯ï¼šæ€»ç»“å·¥ä½œåœ°ç‚¹(Base)ã€æœŸæœ›å…¥èŒæ—¶é—´ã€å·¥ä½œåˆ¶åº¦ï¼ˆå…¨èŒ/å…¼èŒ/è¿œç¨‹ï¼‰ã€å·¥ä½œæ—¶é•¿ç­‰ç›¸å…³ä¿¡æ¯ã€‚
6. æ›¿ä»£æ€§ç»éªŒåˆ†æï¼š
åˆ†æJDä¸­æ ¸å¿ƒèƒ½åŠ›å¹¶åˆ—å‡ºã€‚é’ˆå¯¹æ ¸å¿ƒæŠ€èƒ½è¦æ±‚ç»™å‡ºå¯æ›¿ä»£ç»éªŒï¼Œä¾‹å¦‚ï¼š
    - å¦‚æœæ ¸å¿ƒè¦æ±‚æ˜¯"æµ·å¤–AIå®¢æœäº§å“è®¾è®¡"ï¼Œå¯æ¥å—çš„æ›¿ä»£ç»éªŒåŒ…æ‹¬ï¼š
        - ä»»ä½•æµ·å¤–/å›½é™…åŒ–äº§å“ç»éªŒï¼ˆå¼ºè°ƒæµ·å¤–å›½é™…åŒ–ï¼Œå³ä½¿ä¸æ˜¯å®¢æœé¢†åŸŸï¼‰
        - å›½å†…AIäº§å“è®¾è®¡ç»éªŒï¼ˆå¼ºè°ƒAIäº§å“ç†è§£èƒ½åŠ›ï¼‰
        - å›½å†…å®¢æœäº§å“è®¾è®¡ç»éªŒï¼ˆå¼ºè°ƒä¸“é—¨çš„å®¢æœé¢†åŸŸç†è§£ï¼‰
        - ä¸€èˆ¬äº§å“è®¾è®¡ç»éªŒ
        è¯·æŒ‰ç…§æ›¿ä»£ç»éªŒçš„ç›¸å…³æ€§å¼ºå¼±æ’åºï¼Œå¹¶è¯´æ˜å„ç§ç»„åˆå¦‚ä½•å¼¥è¡¥æ ¸å¿ƒç»éªŒçš„ä¸è¶³ã€‚

è¯·æ ¹æ®JDå†…å®¹ï¼Œå¯¹æ¯ä¸ªç»´åº¦è¿›è¡Œè¯¦ç»†åˆ†æï¼Œç»™å‡ºæœ€ç»ˆçš„åˆ†æç»“æœï¼Œéœ€è¦è¯¦å°½ï¼Œä¸é—æ¼ã€‚`

  const response = await fetch("https://chat.ecnu.edu.cn/open/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      messages: [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å²—ä½åˆ†æä¸“å®¶ï¼Œæ“…é•¿åˆ†æå²—ä½æè¿°ä¸­çš„å„é¡¹è¦æ±‚ã€‚",
        },
        {
          role: "user",
          content: analysisPrompt,
        },
      ],
      model: "ecnu-plus",
      temperature: 0.3,
      stream: false,
    }),
  })

  if (!response.ok) {
    throw new Error(`èŠ‚ç‚¹2 APIè¯·æ±‚å¤±è´¥: ${response.status}`)
  }

  const data = await response.json()
  return data.choices[0]?.message?.content || "JDåˆ†æå¤±è´¥"
}

// èŠ‚ç‚¹3ï¼šåŒ¹é…åˆ†æ
async function performMatchingAnalysis(resumeExtraction: string, jobAnalysis: string, jobDescription: string, apiKey: string) {
  const matchingPrompt = `### è§’è‰²

## ä½ æ˜¯ä¸€ä½èµ„æ·±äººæ‰åŒ¹é…ä¸“å®¶ã€‚è¯·åŸºäºå²—ä½JDä¸å€™é€‰äººç®€å†ï¼ˆCVï¼‰ï¼Œä»æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›ã€æ›¿ä»£ç»éªŒã€å…¶ä»–å› ç´ ä¸‰ä¸ªç»´åº¦ç»¼åˆè¯„ä¼°åŒ¹é…ç¨‹åº¦ï¼Œå¹¶è¾“å‡ºç»“æ„åŒ–ä¸”ç²¾ç®€çš„åŒ¹é…åˆ†æç»“æœã€‚

### âœ… è¾“å…¥å†…å®¹ï¼š

- JDï¼ˆå²—ä½æè¿°ï¼‰ï¼š${jobDescription}
- ç®€å†å†…å®¹ï¼ˆCVï¼‰ï¼š${resumeExtraction}

---

### âœ… åˆ†æç»´åº¦ä¸æƒé‡ï¼š

1. **æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›åŒ¹é…åº¦**ï¼ˆ50%ï¼‰
    - è¯†åˆ« JD ä¸­åˆ—å‡ºçš„æ‰€æœ‰"å¿…é¡»æ ¸å¿ƒèƒ½åŠ›"ï¼Œåˆ†åˆ«é€é¡¹è¯„åˆ†ï¼ˆ0â€“100%ï¼‰ã€‚
    - è¯„åˆ†æ ‡å‡†ï¼š
        - 80â€“100%ï¼šç®€å†æ˜ç¡®å±•ç°è¯¥èƒ½åŠ›ï¼Œå«å…³é”®è¯ + é‡åŒ–æˆæœ
        - 60â€“79%ï¼šæœ‰ç›¸å…³ç»éªŒï¼Œä½†ç¼ºä¹æ·±åº¦æˆ–é‡åŒ–
        - 40â€“59%ï¼šæœ‰ä¸€å®šç›¸ä¼¼ç»éªŒï¼Œä½†éœ€è¾ƒå¤§è½¬åŒ–
        - <40%ï¼šç¼ºä¹æ˜æ˜¾ç›¸å…³ç»éªŒ
    - **è®¡ç®—æ–¹æ³•**ï¼šæŒ‰å„èƒ½åŠ›æƒé‡ Ã— åŒ¹é…åº¦ åŠ æƒæ±‚å’Œã€‚
2. **æ›¿ä»£ç»éªŒä»·å€¼è¯„ä¼°**ï¼ˆ30%ï¼‰
    - è‹¥ç®€å†æœªç›´æ¥è¦†ç›–æ ¸å¿ƒèƒ½åŠ›ï¼Œåˆ™æŒ‰æ›¿ä»£æ€§ç»éªŒæ‹†è§£è¯„åˆ†ã€‚
    - æ›¿ä»£ç»éªŒç»„åˆç¤ºä¾‹ï¼ˆç¤ºæ„åˆ†å€¼ï¼‰ï¼š
        - **é«˜åº¦æ›¿ä»£**ï¼ˆ70%â€“80%åŒ¹é…ä»·å€¼ï¼‰ï¼šæ›¿ä»£æ¯” Ã— æ ¸å¿ƒèƒ½åŠ›æƒé‡ Ã— 0.8
        - **ä¸­åº¦æ›¿ä»£**ï¼ˆ60%â€“70%åŒ¹é…ä»·å€¼ï¼‰ï¼šæ›¿ä»£æ¯” Ã— æ ¸å¿ƒèƒ½åŠ›æƒé‡ Ã— 0.7
        - **ä½åº¦æ›¿ä»£**ï¼ˆ50%â€“59%åŒ¹é…ä»·å€¼ï¼‰ï¼šæ›¿ä»£æ¯” Ã— æ ¸å¿ƒèƒ½åŠ›æƒé‡ Ã— 0.6
    - å‚è€ƒ JD ç¬¬å…­éƒ¨åˆ†"æ›¿ä»£æ€§ç»éªŒåˆ†æ"æ¨¡å—ã€‚
3. **å…¶ä»–åŒ¹é…è¦ç´ **ï¼ˆ20%ï¼‰
    - è€ƒè™‘JDä¸­æåˆ°çš„ ä¸šåŠ¡ä¸å²—ä½æ¦‚å†µã€æ¬¡èƒ½åŠ›ã€å·¥ä½œä¿¡æ¯å’ŒåŸºæœ¬å¤§ç›˜åŒ¹é…åº¦ï¼Œå¦‚ï¼šå­¦å†ã€è¯­è¨€ã€åŸºç¡€æŠ€èƒ½ã€å·¥ä½œåœ°ç‚¹ã€å…¥èŒæ—¶é—´ã€ç‰¹æ®Šå·¥å…·æˆ–æŠ€æœ¯çš„ç†Ÿç»ƒåº¦çš„åŒ¹é…åº¦ç­‰ã€‚
    - ä»…è¯„ä¼° JD ä¸­æ˜ç¡®æåŠçš„è¦ç´ ï¼›æœªæåŠçš„ï¼Œæ ¹æ®èŒçº§æŒ‰è¡Œä¸šé€šç”¨æ ‡å‡†ï¼ˆå¦‚ 985/211/æµ·å¤–åæ ¡åŠ åˆ†ï¼‰ã€‚

---

### âœ… åŒ¹é…è¯„åˆ†æ ‡å‡†ï¼š

Açº§ï¼ˆ90-100åˆ†ï¼‰ï¼šé«˜åº¦åŒ¹é…
æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›åŒ¹é…åº¦â‰¥85%ï¼Œæˆ–æ ¸å¿ƒèƒ½åŠ›+æ›¿ä»£ç»éªŒç»¼åˆåŒ¹é…åº¦â‰¥90%
ä¸”å…¶ä»–åŒ¹é…è¦ç´ å¾—åˆ†â‰¥16åˆ†(æ»¡åˆ†20åˆ†çš„80%)

B+çº§ï¼ˆ80-89åˆ†ï¼‰ï¼šè¾ƒå¥½åŒ¹é…ï¼Œæœ‰ä¼˜åŒ–ç©ºé—´
æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›åŒ¹é…åº¦70-84%ï¼Œæˆ–æ ¸å¿ƒèƒ½åŠ›+æ›¿ä»£ç»éªŒç»¼åˆåŒ¹é…åº¦80-89%
ä¸”å…¶ä»–åŒ¹é…è¦ç´ å¾—åˆ†â‰¥14åˆ†(æ»¡åˆ†20åˆ†çš„70%)

Bçº§ï¼ˆ70-79åˆ†ï¼‰ï¼šåŸºæœ¬åŒ¹é…ï¼Œéœ€è°ƒæ•´
æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›åŒ¹é…åº¦50-69%ï¼Œæˆ–æ ¸å¿ƒèƒ½åŠ›+æ›¿ä»£ç»éªŒç»¼åˆåŒ¹é…åº¦70-79%
ä¸”å…¶ä»–åŒ¹é…è¦ç´ å¾—åˆ†â‰¥10åˆ†(æ»¡åˆ†20åˆ†çš„50%)

Cçº§ï¼ˆ<70åˆ†ï¼‰ï¼šåŒ¹é…åº¦ä½
æ ¸å¿ƒä¸šåŠ¡èƒ½åŠ›åŒ¹é…åº¦<50%ä¸”æ›¿ä»£ç»éªŒä»·å€¼ä¸è¶³
æˆ–å…¶ä»–åŒ¹é…è¦ç´ å¾—åˆ†<10åˆ†(å…³é”®åŸºç¡€æ¡ä»¶ä¸æ»¡è¶³)

---

### âœ… è¾“å‡ºæ ¼å¼

è¯·ä»¥ç®€æ´çš„JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š
{
"score": {
"total": 83,
"core_capabilities": 40,
"alternative_experiences": 25,
"other_factors": 18,
"level_tag": "B+ åŒ¹é…çº§åˆ«"
},
"ability_analysis": [
{
"ability": "èƒ½åŠ›1",
"match": 40,
"status": "å¼±åŒ¹é…",
"alternative": "æ›¿ä»£ç»éªŒç»„åˆ1å¯éƒ¨åˆ†å¼¥è¡¥",
"improvement": "ä¼˜åŒ–å»ºè®®"
},
{
"ability": "èƒ½åŠ›2",
"match": 30,
"status": "ä¸¥é‡ç¼ºå¤±",
"alternative": "æ— æœ‰æ•ˆæ›¿ä»£ç»éªŒ",
"improvement": "å½“å‰ç®€å†æœªè¦†ç›–JDè¦æ±‚çš„å®¢æœæ²Ÿé€š/ç§ä¿¡ç³»ç»Ÿæ–¹å‘æ ¸å¿ƒèƒ½åŠ›ï¼Œå»ºè®®è¡¥å……ç±»ä¼¼é¡¹ç›®æˆ–æ¢å²—ã€‚"
},
{
"ability": "èƒ½åŠ›3",
"match": 85,
"status": "å¼ºåŒ¹é…",
"alternative": "æ— éœ€æ›¿ä»£",
"improvement": "è¿›ä¸€æ­¥çªå‡ºé‡åŒ–æˆæœï¼Œæå‡è¡¨è¾¾ç²¾å‡†åº¦ã€‚"
}
],
"summary": "æ•´ä½“åŒ¹é…åº¦è‰¯å¥½ï¼Œå€™é€‰äººåœ¨äº§å“è§„åˆ’å’Œæ•°æ®åˆ†ææ–¹é¢è¡¨ç°å‡ºè‰²ï¼Œä½†åœ¨è·¨éƒ¨é—¨é¡¹ç›®ç®¡ç†ç»éªŒæ–¹é¢å­˜åœ¨ä¸€å®šçŸ­æ¿ï¼Œå»ºè®®åœ¨ç®€å†ä¸­è¿›ä¸€æ­¥å¼ºåŒ–é¡¹ç›®æ¨è¿›çš„å…·ä½“æˆæœã€‚"
}`

  const response = await fetch("https://chat.ecnu.edu.cn/open/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      messages: [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç®€å†åŒ¹é…åˆ†æä¸“å®¶ï¼Œæ“…é•¿åˆ†æç®€å†ä¸å²—ä½çš„åŒ¹é…åº¦å¹¶æä¾›ä¼˜åŒ–å»ºè®®ã€‚",
        },
        {
          role: "user",
          content: matchingPrompt,
        },
      ],
      model: "ecnu-plus",
      temperature: 0.7,
      stream: false,
    }),
  })

  if (!response.ok) {
    throw new Error(`èŠ‚ç‚¹3 APIè¯·æ±‚å¤±è´¥: ${response.status}`)
  }

  const data = await response.json()
  const content = data.choices[0]?.message?.content

  if (!content) {
    throw new Error("èŠ‚ç‚¹3 APIè¿”å›å†…å®¹ä¸ºç©º")
  }

  // å°è¯•è§£æJSONå“åº”
  try {
    const jsonMatch = content.match(/\{[\s\S]*\}/)
    if (jsonMatch) {
      const parsedResult = JSON.parse(jsonMatch[0])
      // è½¬æ¢æ–°æ ¼å¼åˆ°æ—§æ ¼å¼ï¼Œä¿æŒå‘åå…¼å®¹
      const formatAbilityAnalysis = (abilities: any[]) => {
        if (!abilities || abilities.length === 0) return "æš‚æ— èƒ½åŠ›åˆ†ææ•°æ®"
        
        return abilities.map((item, index) => {
          return `## èƒ½åŠ› ${index + 1}ï¼š${item.ability || 'æœªæŒ‡å®š'}

**åŒ¹é…åº¦ï¼š** ${item.match || 0}%
**çŠ¶æ€ï¼š** ${item.status || 'æœªçŸ¥'}
**æ›¿ä»£ç»éªŒï¼š** ${item.alternative || 'æ— '}
**æ”¹è¿›å»ºè®®ï¼š** ${item.improvement || 'æ— å…·ä½“å»ºè®®'}

---`
        }).join('\n\n')
      }

      return {
        matchScore: parsedResult.score?.total || 0,
        matchLevel: parsedResult.score?.level_tag || "éœ€è¦åˆ†æ",
        coreSkillsMatch: formatAbilityAnalysis(parsedResult.ability_analysis || []),
        summary: parsedResult.summary || "åˆ†æå®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦ç»†å†…å®¹",
        optimizedResume: parsedResult.ability_analysis?.map((item: any) => item.improvement).join('\n') || "æ­£åœ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®...",
        // ä¿ç•™æ–°æ ¼å¼çš„è¯¦ç»†ä¿¡æ¯
        detailedScore: parsedResult.score,
        abilityAnalysis: parsedResult.ability_analysis
      }
    } else {
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°JSONï¼Œåˆ›å»ºé»˜è®¤ç»“æ„
      return {
        matchScore: 0,
        matchLevel: "éœ€è¦åˆ†æ",
        coreSkillsMatch: content,
        summary: "åˆ†æå®Œæˆï¼Œè¯·æŸ¥çœ‹è¯¦ç»†å†…å®¹",
        optimizedResume: "æ­£åœ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®...",
      }
    }
  } catch (parseError) {
    // JSONè§£æå¤±è´¥æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
    return {
      matchScore: 0,
      matchLevel: "åˆ†æå®Œæˆ",
      coreSkillsMatch: content,
      summary: "å·²å®Œæˆåˆ†æï¼Œè¯·æŸ¥çœ‹è¯¦ç»†å†…å®¹",
      optimizedResume: content,
    }
  }
}

// èŠ‚ç‚¹4ï¼šç®€å†ä¼˜åŒ–
async function generateOptimizedResume(
  resumeExtraction: string, 
  jobAnalysis: string, 
  matchingResult: any, 
  jobDescription: string, 
  apiKey: string
) {
  // æå–åŒ¹é…åˆ†æç»“æœä¸­çš„å…³é”®æ•°æ®
  const summary = matchingResult.summary || "æ— åŒ¹é…åˆ†ææ‘˜è¦"
  const abilityAnalysis = matchingResult.coreSkillsMatch || "æ— èƒ½åŠ›åˆ†æ"
  const score = matchingResult.detailedScore || {
    total: matchingResult.matchScore || 0,
    core_capabilities: 0,
    alternative_experiences: 0,
    other_factors: 0,
    level_tag: matchingResult.matchLevel || "æœªè¯„çº§"
  }

  const optimizationPrompt = `### è§’è‰²

ä½ æ˜¯ä¸€ä½èµ„æ·±ç®€å†ä¼˜åŒ–ä¸“å®¶ã€‚ä½ å°†æ ¹æ®ä»¥ä¸‹è¾“å…¥ä¿¡æ¯ï¼Œä¸ºå€™é€‰äººç”Ÿæˆä¸€ä»½é€‚é…ç›®æ ‡å²—ä½ JD çš„ä¼˜åŒ–ç®€å†ç‰ˆæœ¬ï¼Œå¹¶æ ‡è®°æ‰€æœ‰å˜æ›´ã€‚

### å‚è€ƒå†…å®¹ï¼š

\`\`\`
1.	åŸå§‹ç®€å†ï¼ˆCVï¼‰ï¼š${resumeExtraction}
2.	å²—ä½è¦æ±‚ JDï¼ˆæç‚¼åï¼‰ï¼š${jobAnalysis}
3.	åŒ¹é…åˆ†ææ‘˜è¦ï¼š${summary}
4.	æ ¸å¿ƒèƒ½åŠ›åŒ¹é…åˆ†æï¼š${abilityAnalysis}
5.	åŒ¹é…è¯„åˆ†ç­‰çº§ï¼š
â€¢	æ€»åˆ†ï¼š${score.total} åˆ†
â€¢	æ ¸å¿ƒèƒ½åŠ›å¾—åˆ†ï¼š${score.core_capabilities} åˆ†
â€¢	æ›¿ä»£ç»éªŒå¾—åˆ†ï¼š${score.alternative_experiences} åˆ†
â€¢	å…¶ä»–å› ç´ å¾—åˆ†ï¼š${score.other_factors} åˆ†
â€¢	ç­‰çº§æ ‡ç­¾ï¼š${score.level_tag}

\`\`\`

â¸»

âš ï¸ ä¸¥æ ¼çº¦æŸï¼š
â€¢	**ç»å¯¹ç¦æ­¢æ·»åŠ ç®€å†ä¸­æœªå‡ºç°è¿‡çš„é¡¹ç›®ç»å†ã€è¯ä¹¦æˆ–æˆæœã€‚**
â€¢	**ä¸å¾—å°†"å»ºè®®è¡¥å……é¡¹"ç›´æ¥è™šæ„ä¸ºå·²æœ‰å†…å®¹ã€‚
â€¢	å•é¡¹æŠ€èƒ½ï¼ˆå¦‚Azureï¼‰å¯åœ¨å·²æœ‰æŠ€èƒ½ä½“ç³»ä¸‹é€‚åº¦æç‚¼å¼ºåŒ–ï¼Œä½†ç¦æ­¢å‡­ç©ºæ–°å¢æŠ€èƒ½æˆ–æ— ä¾æ®å †å æŠ€èƒ½ã€‚
â€¢	æ‰€æœ‰æ”¹å†™å¿…é¡»åŸºäºåŸå§‹å†…å®¹åŠåŒ¹é…åˆ†æä¸­æ˜ç¡®æŒ‡å‡ºçš„çœŸå®å­—æ®µï¼Œä¸å¾—è™šæ„ã€å¤¸å¤§ã€æé€ ç»å†ã€‚**
â€¢	**ä¸å¾—éšæ„æå‡å²—ä½çº§åˆ«æˆ–è¯¯å¯¼æ€§æè¿°**ï¼Œä¾‹å¦‚å°†æ™®é€šäº§å“å®ä¹ æ”¹å†™ä¸ºAIäº§å“å®ä¹ ã€‚

â¸»

ğŸ§© åŒ¹é…è¯„åˆ†è¡Œä¸ºæ§åˆ¶è¯´æ˜ï¼š

æ ¹æ®åŒ¹é…åˆ†æè¯„åˆ† ${score.total}ï¼Œéµå¾ªå¯¹åº”çš„æ”¹å†™ç­–ç•¥ï¼š
â€¢	90-100 åˆ†ï¼ˆAï¼‰ï¼šç®€å†å·²é«˜åº¦åŒ¹é…JDï¼Œ**ä»…è¯­è¨€ä¼˜åŒ–**ï¼Œç¡®ä¿ç®€æ´æ˜äº†ã€çªå‡ºæˆæœï¼Œç¦æ­¢ç»“æ„å¤§æ”¹ã€‚
â€¢	80-89 åˆ†ï¼ˆB+ï¼‰ï¼šç®€å†æœ‰è¾ƒå¤§ä¼˜åŒ–ç©ºé—´ï¼Œ**é‡ç‚¹å¼ºåŒ–ä¸JDæ ¸å¿ƒä¸šåŠ¡åœºæ™¯å¼ºç›¸å…³çš„å†…å®¹ï¼Œè¿›è¡Œå¤§å¹…åº¦è¯­è¨€ä¼˜åŒ–ï¼Œé€‚åº¦é‡æ’æ¨¡å—å†…é¡ºåºï¼Œçªå‡ºå…³é”®ç»å†ã€‚**
â€¢	70-79 åˆ†ï¼ˆBï¼‰ï¼šç®€å†ä¸JDæœ‰ä¸€å®šåŒ¹é…åº¦ï¼Œ**é‡ç‚¹æŒ–æ˜é«˜ç›¸å…³ç»å†å¹¶å¼ºåŒ–è¡¨è¾¾ï¼Œè¿›è¡Œå¤§å¹…åº¦è¯­è¨€ä¼˜åŒ–ã€‚**
â€¢	<70 åˆ†ï¼ˆCï¼‰ï¼šç®€å†ä¸JDåŒ¹é…åº¦è¾ƒä½ï¼Œ**ä»…è¿›è¡Œè¯­è¨€æ¶¦è‰²**ï¼Œä¸åšç»“æ„é‡ç»„ã€‚

â¸»

ğŸ¯ æ”¹å†™ç›®æ ‡ï¼š

äº§å‡ºä¸€ä»½å®Œæ•´ã€ç¬¦åˆSTARæ³•åˆ™ã€å†…å®¹é‡ç»„ä¸è¡¨è¾¾å¼ºåŒ–åçš„**ä¼˜åŒ–ç‰ˆç®€å†æ­£æ–‡**ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š

1. **å†…å®¹é‡ç»„
â€¢	è°ƒæ•´æ¨¡å—å†…çš„å±•ç¤ºé¡ºåº**ï¼Œå°†ä¸JDæœ€ç›¸å…³çš„ç»å†/æŠ€èƒ½æ’åœ¨å‰é¢ï¼ˆ**å…è®¸æ¨¡å—å†…éƒ¨å¾®è°ƒï¼Œä½†ä¸åšæ— ä¾æ®çš„å¤§å¹…æ—¶é—´è°ƒæ•´**ï¼‰ã€‚
â€¢	ä¼˜å…ˆå¼ºåŒ–ä¸å²—ä½JDå¼ºå…³è”çš„å®ä¹ ä¸é¡¹ç›®ç»å†ï¼Œå¼±åŒ–æ— å…³ç»å†ã€‚
2. **ç»å†æŒ–æ˜ä¸è¡¨è¾¾å¼ºåŒ–
â€¢	éµå¾ªSTARæ³•åˆ™**ï¼šæè¿°éœ€åŒ…å«Situationï¼ˆèƒŒæ™¯ï¼‰ã€Taskï¼ˆä»»åŠ¡ï¼‰ã€Actionï¼ˆè¡ŒåŠ¨ï¼‰ã€Resultï¼ˆæˆæœï¼‰ã€‚
â€¢	**é‡åŒ–æˆæœ**ï¼šé‡‡ç”¨"åŠ¨è¯+å¯¹è±¡+æŒ‡æ ‡"ç»“æ„ï¼Œå¦‚"ä¼˜åŒ–XXæµç¨‹ï¼Œæå‡XXæ•ˆç‡ï¼Œç¼©çŸ­XXæ—¶é—´"ã€‚
è‹¥åŸç®€å†æ— å…·ä½“æ•°æ®ï¼Œå¯ä»¥"XX%"ã€"XXå€"ç­‰å ä½ï¼Œç•™å¾…å€™é€‰äººåç»­è¡¥å……ã€‚
â€¢	**è¡Œä¸šæœ¯è¯­é€‚åº¦åŒ…è£…**ï¼šå¯¹ç…§JDå…³é”®è¯ï¼Œæ›¿æ¢é€šä¿—è¡¨è¾¾ä¸ºè¡Œä¸šæœ¯è¯­ï¼Œä½†**ç¦æ­¢å †ç Œé»‘è¯ã€‚**
â€¢	**ç¦æ­¢å¤¸å¤§**ï¼šæ‰€æœ‰æ”¹å†™å¿…é¡»åŸºäºåŸå§‹ç®€å†å†…å®¹ï¼ŒçœŸå®å¯ä¿¡ã€‚
3. **ç»“æ„è§„èŒƒ**

ä¸¥æ ¼æŒ‰ä»¥ä¸‹é¡ºåºç»„ç»‡ç®€å†ï¼š
1.	æ•™è‚²èƒŒæ™¯
2.	å®ä¹ ç»å†
3.	é¡¹ç›®ç»å†
4.	æŠ€èƒ½è¯ä¹¦
5.	è£èª‰å¥–é¡¹

â¸»

âœ… è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
**è¯·ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹æ ‡è®°æ ¼å¼æ¥æ ‡è¯†æ‰€æœ‰å˜æ›´ç±»å‹**ï¼š

### ğŸ“ æ ‡è®°ä½¿ç”¨è§„åˆ™ï¼š

1. **ä¿æŒä¸å˜çš„å†…å®¹**ï¼šç›´æ¥è¾“å‡ºåŸæ–‡ï¼Œæ— ç‰¹æ®Šæ ‡è®°
   - é€‚ç”¨ï¼šåŸç®€å†ä¸­å·²ç»å¾ˆå¥½ä¸”æ— éœ€ä¿®æ”¹çš„å†…å®¹

2. **æ–°å¢å†…å®¹**ï¼š<add>æ–°å¢çš„å†…å®¹</add>
   - é€‚ç”¨åœºæ™¯ï¼š
     â€¢ åŸºäºåŸæœ‰ç»å†æ‰©å±•çš„é‡åŒ–æ•°æ®ï¼ˆå¦‚"æå‡æ•ˆç‡XX%"ï¼‰
     â€¢ æ ¹æ®JDè¦æ±‚è¡¥å……çš„ç›¸å…³æŠ€èƒ½æè¿°
     â€¢ åŸºäºSTARæ³•åˆ™æ·»åŠ çš„æˆæœæè¿°
     â€¢ ä¸ºçªå‡ºåŒ¹é…åº¦è€Œå¢åŠ çš„è¡Œä¸šå…³é”®è¯
   - âš ï¸ æ³¨æ„ï¼šå¿…é¡»åŸºäºåŸç®€å†çœŸå®å†…å®¹ï¼Œä¸å¾—å‡­ç©ºç¼–é€ 

3. **åˆ é™¤å†…å®¹**ï¼š<del>è¢«åˆ é™¤çš„å†…å®¹</del>
   - é€‚ç”¨åœºæ™¯ï¼š
     â€¢ ä¸JDæ— å…³æˆ–åŒ¹é…åº¦ä½çš„ç»å†æè¿°
     â€¢ å†—ä½™ã€é‡å¤çš„è¡¨è¿°
     â€¢ ä¸å¤Ÿä¸“ä¸šæˆ–è¿‡äºå£è¯­åŒ–çš„è¡¨è¾¾
     â€¢ ç¼ºä¹é‡åŒ–æˆæœçš„ç©ºæ³›æè¿°

4. **å±€éƒ¨ä¼˜åŒ–å†…å®¹**ï¼š<optimize>ä¼˜åŒ–åçš„å†…å®¹</optimize>
   - é€‚ç”¨åœºæ™¯ï¼š
     â€¢ å°†é€šä¿—è¯æ±‡æ›¿æ¢ä¸ºè¡Œä¸šä¸“ä¸šæœ¯è¯­
     â€¢ è°ƒæ•´è¡¨è¾¾æ–¹å¼ä»¥æ›´ç¬¦åˆJDè¦æ±‚
     â€¢ é‡æ–°ç»„ç»‡è¯­è¨€ç»“æ„ä»¥çªå‡ºé‡ç‚¹
     â€¢ å°†è¢«åŠ¨è¡¨è¿°æ”¹ä¸ºä¸»åŠ¨è¡¨è¿°
     â€¢ ä¼˜åŒ–æ—¶é—´è¡¨è¿°ã€èŒä½åç§°ç­‰

### ğŸ“‹ å®é™…åº”ç”¨ç¤ºä¾‹ï¼š

**åŸæ–‡**ï¼šåœ¨å…¬å¸åšäº§å“ç›¸å…³å·¥ä½œï¼Œè´Ÿè´£ä¸€äº›è®¾è®¡ä»»åŠ¡
**ä¼˜åŒ–å**ï¼šåœ¨<optimize>äº’è”ç½‘å…¬å¸æ‹…ä»»äº§å“è®¾è®¡å®ä¹ ç”Ÿ</optimize>ï¼Œè´Ÿè´£<optimize>ç”¨æˆ·ä½“éªŒè®¾è®¡ä¸äº§å“åŸå‹åˆ¶ä½œ</optimize>ï¼Œ<add>å®Œæˆ15ä¸ªåŠŸèƒ½æ¨¡å—è®¾è®¡ï¼Œç”¨æˆ·æ»¡æ„åº¦æå‡25%</add><del>è´Ÿè´£ä¸€äº›è®¾è®¡ä»»åŠ¡</del>

**åŸæ–‡**ï¼šç†Ÿæ‚‰Pythonç¼–ç¨‹
**ä¼˜åŒ–å**ï¼šç†Ÿæ‚‰<optimize>Pythonæ•°æ®åˆ†æä¸æœºå™¨å­¦ä¹ å¼€å‘</optimize>ï¼Œ<add>æŒæ¡pandasã€numpyã€scikit-learnç­‰æ ¸å¿ƒåº“ï¼Œå®Œæˆ3ä¸ªæ•°æ®æŒ–æ˜é¡¹ç›®</add>

### âš¡ æ‰§è¡Œè¦æ±‚ï¼š
â€¢ æ¯å¤„å˜æ›´éƒ½å¿…é¡»ä½¿ç”¨å¯¹åº”æ ‡è®°ï¼Œä¸å¾—é—æ¼
â€¢ æ ‡è®°å†…å®¹è¦ä¸æ ‡è®°ç±»å‹å‡†ç¡®åŒ¹é…
â€¢ ä¿æŒæ ‡è®°çš„å®Œæ•´æ€§ï¼Œç¡®ä¿å‰ç«¯èƒ½æ­£ç¡®è§£æ
â€¢ è¾“å‡ºå®Œæ•´çš„ä¼˜åŒ–ç‰ˆç®€å†æ­£æ–‡ï¼ŒåŒ…å«æ‰€æœ‰å˜æ›´æ ‡è®°
â€¢ ä¸¥ç¦è¾“å‡ºä»»ä½•è§£é‡Šè¯´æ˜ã€æ³¨é‡Šæˆ–å…¶ä»–æ ¼å¼ä¿¡æ¯`

  const response = await fetch("https://chat.ecnu.edu.cn/open/api/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      messages: [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç®€å†ä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿æ ¹æ®å²—ä½è¦æ±‚å’ŒåŒ¹é…åˆ†æç»“æœä¼˜åŒ–ç®€å†å†…å®¹ã€‚",
        },
        {
          role: "user",
          content: optimizationPrompt,
        },
      ],
      model: "ecnu-plus",
      temperature: 0.5,
      stream: false,
    }),
  })

  if (!response.ok) {
    throw new Error(`èŠ‚ç‚¹4 APIè¯·æ±‚å¤±è´¥: ${response.status}`)
  }

  const data = await response.json()
  return data.choices[0]?.message?.content || "ç®€å†ä¼˜åŒ–å¤±è´¥"
}
