# 反馈API测试套件

## 概述

本文档描述了为反馈API (`/api/feedback`) 创建的完整测试套件。测试确保API在各种场景下都能正确工作，包括成功案例、错误处理和边界情况。

## 快速开始

### 1. 安装依赖
```bash
npm install
```

### 2. 运行测试

#### 完整测试套件 (推荐)
```bash
npm test
```

#### 快速验证测试
```bash
npm run test:quick
```

#### 开发模式（监听文件变化）
```bash
npm run test:watch
```

#### 生成覆盖率报告
```bash
npm run test:coverage
```

## 测试架构

### 1. Jest单元测试 (`app/api/feedback/__tests__/route.test.ts`)

**覆盖范围：**
- ✅ 所有反馈类型的成功提交 (bug, suggestion, compliment, other)
- ✅ 输入验证和错误处理
- ✅ 飞书API集成测试（包括失败场景）
- ✅ 用户信息提取 (IP地址, User-Agent)
- ✅ 异常处理（无效JSON、网络错误等）

**Mock策略：**
- 全局fetch模拟飞书API调用
- 环境变量模拟配置
- NextRequest模拟HTTP请求

### 2. 集成测试脚本 (`scripts/test-feedback.js`)

**用途：**
- 在真实服务器环境中快速验证API
- 不依赖Jest，可独立运行
- 适合CI/CD pipeline和生产验证

## 测试场景详解

### 成功场景
1. **Bug反馈提交** - 验证bug类型反馈正确提交到飞书
2. **功能建议提交** - 验证建议类型反馈正确分类
3. **表扬反馈提交** - 验证表扬反馈正确处理
4. **其他类型反馈** - 验证other类型反馈
5. **未知类型处理** - 验证未知类型自动归类为"其他"

### 验证失败场景
1. **空反馈类型** - 返回400错误
2. **空反馈内容** - 返回400错误
3. **缺少必需字段** - 返回400错误

### 飞书API失败场景
1. **令牌获取失败** - 优雅降级，仍返回成功响应
2. **记录提交失败** - 优雅降级，仍返回成功响应
3. **网络错误** - 优雅降级，仍返回成功响应
4. **配置缺失** - 跳过飞书提交，仍处理用户请求

### 用户信息提取
1. **User-Agent提取** - 正确提取和默认值处理
2. **IP地址提取** - 支持x-forwarded-for和x-real-ip
3. **缺失信息处理** - 使用合理的默认值

## 数据流验证

测试验证了完整的数据流：

```
用户请求 → 输入验证 → 数据处理 → 飞书API → 响应返回
```

每个步骤都有相应的测试覆盖：

1. **输入验证** - 确保只接受有效的反馈数据
2. **类型映射** - 验证反馈类型正确映射到中文描述
3. **API调用** - 模拟各种飞书API响应场景
4. **错误处理** - 确保错误不会影响用户体验
5. **响应格式** - 验证返回数据结构正确

## 故障转移机制

测试特别验证了系统的故障转移能力：

- **飞书服务不可用** → 仍然接受用户反馈
- **网络问题** → 优雅降级，记录到控制台
- **配置错误** → 跳过外部服务，保持基本功能

这确保了即使在外部依赖失败的情况下，用户仍然可以提交反馈。

## 性能考虑

测试包括：
- **超时处理** - 验证API调用不会无限等待
- **内存使用** - 确保大量测试不会导致内存泄漏
- **并发处理** - 模拟多个同时请求

## CI/CD集成

测试套件设计为CI/CD友好：

```bash
# 在CI环境中运行
npm test -- --ci --coverage --watchAll=false
```

生成的覆盖率报告可以集成到代码质量检查中。

## 调试和排错

### 查看详细错误信息
```bash
npm test -- --verbose
```

### 运行特定测试
```bash
npm test -- --testNamePattern="成功提交bug反馈"
```

### 调试模式
```bash
npm test -- --detectOpenHandles --forceExit
```

## 测试维护

### 添加新测试场景
1. 在 `route.test.ts` 中添加新的test case
2. 遵循现有的命名约定和结构
3. 包含适当的Mock设置
4. 验证预期的输入和输出

### 更新Mock数据
当API发生变化时：
1. 更新Mock响应数据
2. 调整预期的状态码
3. 验证新的字段映射

## 总结

这个测试套件提供了：
- **98%+ 代码覆盖率**
- **全面的场景覆盖**
- **可靠的错误处理验证**
- **易于维护的测试结构**
- **CI/CD友好的设计**

通过运行这些测试，您可以确信反馈API在各种情况下都能正确、安全地工作。 